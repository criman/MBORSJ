# 旁通阀功能单元测试说明

## 概述

本测试文件 `ByPassValve_test.c` 用于对 `ByPassValve.c` 中的 `Func_BPV()` 函数进行单元测试，验证旁通阀控制逻辑是否符合规格书要求。

## 测试覆盖范围

### 关闭条件测试
1. **测试用例1**: 压机关闭时，旁通阀应该关闭
2. **测试用例2**: 排气温度≤P21(85℃)时，旁通阀应该关闭
3. **测试用例3**: 水箱温度≤P22(30℃)时，旁通阀应该关闭

### 开启条件测试
4. **测试用例4**: 满足开启条件1（Tair≥P17且Tw≥P18且Td≥P19），旁通阀应该开启
5. **测试用例5**: 满足开启条件2（Td≥P20=103℃），旁通阀应该开启

### 边界条件测试
6. **测试用例6**: Tair刚好等于P17的边界测试
7. **测试用例7**: Tair略低于P17的边界测试
8. **测试用例8**: Td刚好等于P21的边界测试

### 实际场景测试
9. **测试用例9**: 用户报告的问题场景（Tair=50.4℃，Tw=45.4℃，Td=95.7℃）

### 状态转换测试
10. **测试用例10**: 从关闭到开启的状态转换
11. **测试用例11**: 从开启到关闭的状态转换（包含延迟关闭逻辑）

### 特殊功能测试
12. **测试用例12**: 强制开启标志测试

## 规格书要求

### 开启条件
- 压缩机开启的条件下则旁通阀允许开启
- 条件1：当检测到环境温度Tair≥50℃（参数P17）且水箱温度Tw≥45℃（参数P18）且排气温度Td≥95℃（参数P19）时，开启旁通阀
- 条件2：当检测到排气温度Td≥103℃（参数P20）时，开启旁通阀

### 关闭条件
满足以下条件之一，则关闭旁通阀：
1. 压缩机排气温度Td≤85℃（参数P21）
2. 水箱温度Tw≤30℃（参数P22）
3. 压缩机关闭时
4. 其它故障保护要求关闭的情况

## 编译和运行

### 前提条件
- 需要包含项目的主要头文件 `main.h`
- 需要链接相关的库文件
- 需要定义以下外部变量和函数：
  - `STRUCT_BPV BPV`
  - `STRUCT_COMP Comp`
  - `STRUCT_TEMPRATURE T4, T5, Tp`
  - `STRUCT_FTYPARA FtyPara`
  - `TempValueMul10()` 函数

### 编译方法
```bash
# 在项目根目录下
gcc -o ByPassValve_test code/Function/ByPassValve_test.c \
    code/Function/ByPassValve.c \
    code/Function/Tempr.c \
    -I. -Icode/Function -Icode/Module \
    -DUNIT_TEST  # 如果需要定义单元测试宏
```

### 运行测试
```bash
./ByPassValve_test
```

## 测试结果解读

测试程序会输出：
- 每个测试用例的执行结果（PASS/FAIL）
- 测试统计信息：
  - 总测试用例数
  - 通过的测试用例数
  - 失败的测试用例数
  - 通过率

## 注意事项

1. **模拟函数**: 测试中使用了模拟的硬件函数 `P_BPV_On()` 和 `P_BPV_Off()`，这些函数只记录调用次数，不执行实际硬件操作。

2. **外部依赖**: 测试需要访问全局变量和函数，确保在编译时正确链接所有依赖项。

3. **参数设置**: 测试使用默认参数值（P17=50, P18=45, P19=95, P20=103, P21=85, P22=30），如需测试其他参数值，可修改 `setup_test_environment()` 函数。

4. **嵌入式环境**: 如果是在嵌入式环境中运行，可能需要：
   - 修改 `main()` 函数为测试入口函数
   - 使用嵌入式测试框架（如Unity、CppUTest等）
   - 调整内存分配和输出方式

## 扩展测试

如需添加新的测试用例，可以：
1. 创建新的测试函数，命名格式：`test_case_XX_description()`
2. 在 `main()` 函数中调用新测试函数
3. 使用 `TEST_ASSERT()` 和 `TEST_PASS()` 宏进行断言

## 维护记录

- 2025/01/XX: 初始版本，包含12个测试用例

